<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>JD Analyzer</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f6f8fa;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 920px;
      margin: 80px auto;
      background: #fff;
      padding: 48px;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
    }
    h1 {
      margin: 0;
      font-size: 34px;
      text-align: center;
      letter-spacing: 0.2px;
    }
    .subtitle {
      text-align: center;
      color: #6b7280;
      margin-top: 10px;
      margin-bottom: 22px;
    }

    .mode-row{
      display:flex;
      justify-content:center;
      gap:18px;
      margin: 8px 0 18px;
      color:#111827;
      font-size:14px;
    }
    .mode-row label { cursor:pointer; }

    .panel {
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 14px;
      background: #fbfdff;
    }

    input[type="text"]{
      width: 100%;
      box-sizing: border-box;
      padding: 14px 16px;
      font-size: 15px;
      border: 1px solid #d1d5db;
      border-radius: 10px;
      outline: none;
    }
    input[type="text"]:focus, textarea:focus {
      border-color: #4f46e5;
      box-shadow: 0 0 0 3px rgba(79,70,229,0.12);
    }
    textarea{
      width: 100%;
      min-height: 170px;
      box-sizing: border-box;
      padding: 14px 16px;
      font-size: 14px;
      border: 1px solid #d1d5db;
      border-radius: 10px;
      outline: none;
      resize: vertical;
      line-height: 1.5;
      white-space: pre-wrap;
    }

    .actions {
      display:flex;
      justify-content:flex-start;
      gap: 12px;
      margin-top: 14px;
      align-items:center;
    }

    button {
      background: #4f46e5;
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 11px 18px;
      font-size: 15px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    button:hover { background: #4338ca; }
    .hint {
      color: #6b7280;
      font-size: 13px;
    }

    .result-box {
      margin-top: 30px;
    }
    .result-title {
      font-weight: 700;
      font-size: 20px;
      margin-bottom: 8px;
    }
    .status {
      margin-top: 4px;
      font-size: 14px;
      color: #6b7280;
    }
    .status.ok { color: #065f46; font-weight: 600; }
    .status.err { color: #b91c1c; font-weight: 600; }

    .card {
      background: #f9fafb;
      border: 1px solid #eef2f7;
      border-radius: 12px;
      padding: 18px;
      margin-top: 14px;
    }
    .card h3 {
      margin: 0 0 10px;
      font-size: 16px;
    }

    .kv p { margin: 6px 0; }
    .kv strong { color: #111827; }

    .tags{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .tag{
      background:#e0e7ff;
      color:#3730a3;
      padding:6px 12px;
      border-radius:999px;
      font-size:13px;
      border: 1px solid rgba(55,48,163,0.12);
    }

    /* ‚úÖ ResponsibilitiesÊç¢Ë°åÂÖ≥ÈîÆÔºö‰∏çË¶ÅnowrapÔºåÂÖÅËÆ∏Êñ≠ËØç */
    ul.clean {
      margin: 8px 0 0;
      padding-left: 18px;
    }
    ul.clean li{
      margin: 8px 0;
      white-space: normal;
      overflow-wrap: anywhere;
      word-break: break-word;
      line-height: 1.55;
    }

    /* ËÆ©È°µÈù¢Êõ¥ÂÉè‰Ω†Êà™ÂõæÈÇ£ÁßçÊ∏ÖÁàΩÂ∏ÉÂ±Ä */
    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    /* ÈöêËóè/ÊòæÁ§∫ */
    .hidden { display:none; }
  </style>
</head>

<body>
  <div class="container">
    <h1>Job Description Analyzer</h1>
    <div class="subtitle">
      Analyze via URL (best-effort) or paste JD text directly (recommended)
    </div>

    <div class="mode-row">
      <label><input type="radio" name="mode" value="url" checked> URL</label>
      <label><input type="radio" name="mode" value="text"> Text</label>
    </div>

    <div class="panel">
      <form id="jobForm" action="javascript:void(0);">
        <div id="urlBox">
          <input
            id="job_url"
            type="text"
            name="job_url"
            placeholder="https://job-boards.greenhouse.io/...  (best-effort)"
          />
        </div>

        <div id="textBox" class="hidden" style="margin-top:12px;">
          <textarea
            id="jd_text"
            name="jd_text"
            placeholder="Paste the full job description text here..."
          ></textarea>
        </div>

        <div class="actions">
          <button type="submit">üîé Analyze</button>
          <div class="hint">Tip: Text mode is the most reliable and will produce the most complete structured result.</div>
        </div>
      </form>
    </div>

    <div class="result-box">
      <div class="result-title">Analysis Result</div>
      <div id="status" class="status">Idle.</div>

      <div id="result" class="grid hidden">

        <div class="card">
          <h3>Job Overview</h3>
          <div class="kv">
            <p><strong>Company:</strong> <span id="company"></span></p>
            <p><strong>Job Title:</strong> <span id="job_title"></span></p>
            <p><strong>Seniority:</strong> <span id="seniority"></span></p>
          </div>
        </div>

        <div class="card">
          <h3>Education</h3>
          <div class="kv">
            <p><strong>Required:</strong> <span id="edu_required"></span></p>
            <p><strong>Preferred:</strong> <span id="edu_preferred"></span></p>
          </div>
        </div>

        <div class="card">
          <h3>Fields</h3>
          <div class="tags" id="fields"></div>
        </div>

        <div class="card">
          <h3>Responsibilities</h3>
          <ul class="clean" id="responsibilities"></ul>
        </div>

        <div class="card">
          <h3>Required Skills</h3>
          <div class="tags" id="required_skills"></div>
        </div>

        <div class="card">
          <h3>Preferred Skills</h3>
          <div class="tags" id="preferred_skills"></div>
        </div>

        <div class="card">
          <h3>Skill Buckets</h3>
          <div id="skill_buckets"></div>
        </div>

      </div>
    </div>
  </div>

  <script>
    const statusEl = document.getElementById("status");
    const resultEl = document.getElementById("result");

    const urlBox = document.getElementById("urlBox");
    const textBox = document.getElementById("textBox");

    // Skill bucket label mapÔºà‰Ω†Ë¶ÅÁöÑÂ§ßÂÜô/Êõ¥Â•ΩÁúãÔºâ
    const BUCKET_LABEL = {
      ai_ml: "AI/ML",
      cloud: "CLOUD",
      data_systems: "DATA SYSTEMS",
      frameworks: "FRAMEWORKS",
      languages: "LANGUAGES",
    };

    function setStatus(msg, type="") {
      statusEl.textContent = msg;
      statusEl.className = "status " + (type || "");
    }

    function showResult(show) {
      resultEl.classList.toggle("hidden", !show);
    }

    function renderTags(container, arr) {
      container.innerHTML = "";
      const list = Array.isArray(arr) ? arr : [];
      if (!list.length) {
        container.innerHTML = "<span style='color:#6b7280;'>None</span>";
        return;
      }
      list.forEach(x => {
        const s = document.createElement("span");
        s.className = "tag";
        s.textContent = x;
        container.appendChild(s);
      });
    }

    function renderList(ul, arr) {
      ul.innerHTML = "";
      const list = Array.isArray(arr) ? arr : [];
      if (!list.length) {
        const li = document.createElement("li");
        li.textContent = "None";
        ul.appendChild(li);
        return;
      }
      list.forEach(x => {
        const li = document.createElement("li");
        li.textContent = x;
        ul.appendChild(li);
      });
    }

    function textOrNone(x) {
      if (Array.isArray(x)) return x.length ? x.join(", ") : "None";
      if (typeof x === "string") return x.trim() ? x : "None";
      if (x === null || x === undefined) return "None";
      return String(x);
    }

    function safeGet(obj, path, fallback) {
      try {
        return path.split(".").reduce((acc, k) => acc[k], obj) ?? fallback;
      } catch {
        return fallback;
      }
    }

    function renderBuckets(container, bucketsObj) {
      container.innerHTML = "";
      const b = (bucketsObj && typeof bucketsObj === "object") ? bucketsObj : {};
      const keys = Object.keys(b);
      if (!keys.length) {
        container.innerHTML = "<div style='color:#6b7280;'>None</div>";
        return;
      }

      keys.forEach(k => {
        const row = document.createElement("div");
        row.style.margin = "6px 0";

        const label = document.createElement("strong");
        label.textContent = (BUCKET_LABEL[k] || k.toUpperCase().replaceAll("_"," ")) + ": ";
        row.appendChild(label);

        const v = b[k];
        const text = Array.isArray(v) ? (v.length ? v.join(", ") : "None") : (v || "None");
        const span = document.createElement("span");
        span.textContent = text;
        row.appendChild(span);

        container.appendChild(row);
      });
    }

    // ÂàáÊç¢URL/Text
    document.querySelectorAll("input[name='mode']").forEach(r => {
      r.addEventListener("change", () => {
        const mode = document.querySelector("input[name='mode']:checked").value;
        if (mode === "url") {
          urlBox.classList.remove("hidden");
          textBox.classList.add("hidden");
        } else {
          urlBox.classList.add("hidden");
          textBox.classList.remove("hidden");
        }
        showResult(false);
        setStatus("Idle.");
      });
    });

    // Êèê‰∫§
    document.getElementById("jobForm").addEventListener("submit", async () => {
      const mode = document.querySelector("input[name='mode']:checked").value;
      const jobUrl = document.getElementById("job_url").value.trim();
      const jdText = document.getElementById("jd_text").value.trim();

      const fd = new FormData();
      fd.append("mode", mode);
      if (mode === "url") fd.append("job_url", jobUrl);
      else fd.append("jd_text", jdText);

      setStatus("Analyzing...", "");
      showResult(false);

      try {
        const res = await fetch("/analyze", { method: "POST", body: fd });
        const data = await res.json();

        if (!res.ok || data.error) {
          setStatus(data.error || "Error analyzing job description.", "err");
          return;
        }

        setStatus("Done.", "ok");
        showResult(true);

        // overview
        document.getElementById("company").textContent = textOrNone(data.company);
        document.getElementById("job_title").textContent = textOrNone(data.job_title);
        document.getElementById("seniority").textContent = textOrNone(data.seniority);

        // education
        document.getElementById("edu_required").textContent = textOrNone(safeGet(data, "education.required", []));
        document.getElementById("edu_preferred").textContent = textOrNone(safeGet(data, "education.preferred", []));

        // fields/skills/responsibilities
        renderTags(document.getElementById("fields"), data.fields);
        renderList(document.getElementById("responsibilities"), data.responsibilities);
        renderTags(document.getElementById("required_skills"), data.required_skills);
        renderTags(document.getElementById("preferred_skills"), data.preferred_skills);

        // buckets
        renderBuckets(document.getElementById("skill_buckets"), data.skill_buckets);

      } catch (e) {
        setStatus("Error analyzing job description.", "err");
      }
    });
  </script>
</body>
</html>
